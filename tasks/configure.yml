---

- name: create /etc/icingaweb2 directory
  file:
    name: /etc/icingaweb2
    state: directory
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: '0750'

- name: install database
  include_tasks: database/mysql.yml

- name: create modules directories
  file:
    name: '{{ item }}'
    state: directory
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: 0750
  loop:
    - /etc/icingaweb2/modules
    - /etc/icingaweb2/enabledModules

- name: create log directory
  file:
    name: '{{ item }}'
    state: directory
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: 0775
  loop:
    - /var/log/icingaweb2

- name: create dashboard directory
  file:
    name: '{{ item }}'
    state: directory
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: 0750
  loop:
    - /etc/icingaweb2/dashboards

- name: create configurations
  template:
    src: "{{ item }}.j2"
    dest: "/etc/icingaweb2/{{ item }}"
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: 0666
  loop:
    - resources.ini
    - config.ini
    - authentication.ini
    - groups.ini
    - roles.ini

- name: ensure rights for config.ini
  file:
    path: /etc/icingaweb2/config.ini
    group: "{{ icingaweb_group }}"
    mode: 0666

- name: ensure module directory exists
  file:
    name: '/etc/icingaweb2/modules/{{ item }}'
    state: directory
    group: "{{ icingaweb_group }}"
    mode: 0770
  loop:
    - monitoring

- name: disable icingaweb modules
  file:
    state: absent
    path: "/etc/icingaweb2/enabledModules/{{ item }}"
  loop:
    '{{ icingaweb_modules_disabled }}'

- name: enable icingaweb modules
  file:
    state: link
    src: '{{ icingaweb_install_dir }}/modules/{{ item }}'
    dest: '/etc/icingaweb2/enabledModules/{{ item }}'
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: 0750
    force: true
  loop:
    '{{ icingaweb_modules_enabled | list }}'

- name: create monitoring modules configuration
  template:
    src: modules/monitoring/{{ item }}.ini.j2
    dest: /etc/icingaweb2/modules/monitoring/{{ item }}.ini
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: 0666
  loop:
    - config
    - backends
    - commandtransports

# userhandling in database
- block:
    - name: merge icingaweb_users with password hashes
      set_fact:
        icingaweb_users: "{{ icingaweb_users | create_password_hash }}"

    - name: create temporary icingaweb_users statement
      template:
        src: create_user.sql.j2
        dest: /tmp/create_user.sql
        mode: 0666
      no_log: true
      loop:
        - "{{ icingaweb_users }}"

    - name: import icingaweb users into database
      mysql_db:
        login_host: '{{ icingaweb_auth_backend.host }}'
        config_file: /etc/icingaweb2/.my.cnf
        restrict_config_file: true
        state: import
        name: "{{ icingaweb_auth_backend.dbname }}"
        target: /tmp/create_user.sql
      register: icingaweb2_import_users
      no_log: true

  when: icingaweb_users is defined and icingaweb_users | count != 0

- name: change ownership of /etc/icingaweb2 directory
  file:
    name: /etc/icingaweb2
    state: directory
    owner: "{{ icingaweb_user }}"
    group: "{{ icingaweb_group }}"
    mode: 0750
    # recurse: true
