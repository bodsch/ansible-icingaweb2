---

# TODO
# drop python2 support!
# add assert

# - name: assert python version
#   assert:
#     that: ansible_python.version.major != 2
#     msg: "Sorry, we don't support python 2 anymore!"

- name: include OS specific configuration
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      paths:
        - "vars"
      files:
        # eg. debian-10 / ubuntu-20 / centos-8 / oraclelinux-8
        - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yaml"
        # eg. debian / ubuntu / centos / oraclelinux
        - "{{ ansible_distribution | lower }}.yaml"
        # eg. redhat / debian
        - "{{ ansible_os_family | lower }}.yaml"
        - default.yaml
      skip: true

# - block:
#     - name: detect python3 binary
#       stat:
#         path: "/usr/bin/python3"
#       register: python3_binary
#
#     - name: set fact for ansible_python_interpreter to /usr/bin/python3
#       set_fact:
#         ansible_python_interpreter: /usr/bin/python3
#       when:
#         python3_binary.stat.exists
#
#     - name: get latest system information
#       setup:

- block:
    - name: make sure python3-apt is installed (only debian based)
      package:
        name:
          - python3-apt
        state: present

    - name: clean apt cache
      command: apt-get clean
      args:
        warn: false
  when:
    - ansible_os_family | lower == 'debian'

# - block:
#     - name: make sure dnf is installed (only redhat based <8)
#       package:
#         name:
#           - dnf
#           - iproute
#         state: present
#
#     - name: get latest system information
#       setup:
#   when:
#     - ansible_os_family | lower == 'redhat'
#     - ansible_distribution | lower == 'centos'
#     - ansible_distribution_version | int < 8

- name: create local temp directory
  become: false
  delegate_to: 127.0.0.1
  file:
    path: "{{ icingaweb_local_tmp_directory }}"
    state: directory
    mode: 0755

- name: get version of installed php-fpm
  package_version:
    package_name: "php-fpm"
  register: package_version

- debug:
    msg: "{{ package_version }}"

- name: define php version
  set_fact:
    php_version: "{{ package_version.version }}"
    php_package_version: "{{ package_version.version_compressed }}"
  when:
    - package_version is defined
    - package_version.version is defined
    - package_version.version_compressed is defined

- name: assert php_version
  assert:
    that:
      - php_version is defined
      - php_version is version_compare('7.0', '>=')
    msg: "This role only works with PHP >= 7.0 .. found: {{ php_version }}"

- name: merge dependencies between defaults and custom
  set_fact:
    icingaweb_dependencies: "{{ icingaweb_dependencies + icingaweb_packages }}"

- name: get database package name
  package_version:
    package_name: "mariadb-client-core"
  register: package_version

- name: remove mariadb-client-core from dependency list if it already installed
  set_fact:
    icingaweb_dependencies: "{{ icingaweb_dependencies | reject('search', 'default-mysql-client-core') | list }}"
  when:
    - package_version.version is defined

- name: merge dependencies between defaults and custom for enabled icingaweb modules
  set_fact:
    icingaweb_modules_enabled: "{{ icingaweb_defaults_modules_enabled + icingaweb_modules_enabled }}"

- name: merge icingaweb_groups configuration between defaults and custom
  set_fact:
    icingaweb_groups: "{{ icingaweb_defaults_groups |
      combine( icingaweb_groups, recursive=True ) }}"

- name: merge icingaweb_authentication configuration between defaults and custom
  set_fact:
    icingaweb_authentication: "{{ icingaweb_defaults_authentication |
      combine( icingaweb_authentication, recursive=True ) }}"

- name: merge icingaweb_resources configuration between defaults and custom
  set_fact:
    icingaweb_resources: "{{ icingaweb_defaults_resources |
      combine( icingaweb_resources, recursive=True ) }}"

- name: install requirements
  package:
    name: "{{ icingaweb_dependencies }}"
    state: present

- block:
    - name: "find primary group for user '{{ icingaweb_user }}'"
      getent:
        database: group
        key: "{{ icingaweb_user }}"
        split: ':'

    - name: "set icingaweb_group '{{ getent_group | list | first }}'"
      set_fact:
        icingaweb_group: "{{ getent_group | list | first }}"
      when:
        - getent_group is defined
  when:
    - not icingaweb_group is defined or icingaweb_group | length > 0
...
